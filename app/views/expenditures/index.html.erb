<h1>Cheltuieli</h1>

<p><%= link_to 'Înapoi la pagina principală', root_path %></p>
<p><%= link_to 'Adaugă o cheltuială nouă', new_expenditure_path %></p>
<% if current_user.admin? %>
  <p><%= link_to 'Importă cheltuieli din Excel', import_expenditures_path %></p>
<% end %>

<%= render partial: 'flashes' %>

<%= bootstrap_form_with method: :get, layout: :inline do |form| %>
  <%= form.text_field :start_date, value: params[:start_date], label: 'Data de început',
                      data: { datepicker: true, max_date: Time.zone.today.strftime('%d.%m.%Y') } %>
  <%= form.text_field :end_date, value: params[:end_date], label: 'Data de sfârșit',
                      data: { datepicker: true, max_date: Time.zone.today.strftime('%d.%m.%Y') } %>
  <%= form.text_field :expenditure_category_code,
                      value: params[:expenditure_category_code],
                      label: 'Indicator tip de cheltuială',
                      placeholder: 'Exemplu: C1' %>
  <%= form.select :financing_source_ids,
                  FinancingSource.order(:name).map { |financing_source|
                    [financing_source.name, financing_source.id]
                  },
                  {
                    multiple: true,
                    selected: @financing_source_ids,
                    label: 'Sursă de finanțare (centru de cost)',
                    wrapper: { class: 'col-12' }
                  },
                  {
                    data: {
                      use_select2: true,
                      placeholder: 'Selectează o sursă de finanțare...'
                    }
                  } %>
  <%= form.select :expenditure_article_ids,
                  ExpenditureArticle.order(:code).map { |expenditure_article|
                    ["#{expenditure_article.code} - #{expenditure_article.name}", expenditure_article.id]
                  },
                  {
                    multiple: true,
                    selected: @expenditure_article_ids,
                    label: 'Articol de cheltuială',
                    wrapper: { class: 'col-12' }
                  },
                  {
                    data: {
                      use_select2: true,
                      placeholder: 'Selectează un articol de cheltuială...'
                    }
                  }
  %>
  <%= form.submit 'Filtrează' %>
<% end %>

<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
    <tr>
      <th scope="col">Număr de înregistrare</th>
      <th scope="col">Data înregistrării</th>
      <th scope="col">Sursă de finanțare</th>
      <th scope="col">Categorie proiect</th>
      <th scope="col">Detalii proiect</th>
      <th scope="col">Articol de cheltuială</th>
      <th scope="col">Detalii</th>
      <th scope="col">Tip achiziție</th>
      <th scope="col">Număr ordonanțare</th>
      <th scope="col">Dată ordonanțare</th>
      <th scope="col">Valoare plată (RON)</th>
      <th scope="col">Metodă de plată</th>
      <th scope="col">Beneficiar</th>
      <th scope="col">Factură</th>
      <th scope="col">Neconformitate</th>
      <th scope="col">Observații</th>
      <th scope="col">Creat de</th>
      <th scope="col">Creat la data de</th>
      <th scope="col">Acțiuni</th>
    </tr>
    </thead>
    <tbody>
    <% @paginated_expenditures.each do |expenditure| %>
      <tr>
        <th scope="row"><%= expenditure.registration_number %>/<%= expenditure.year %></th>
        <td><%= expenditure.registration_date.strftime('%d.%m.%Y') %></td>
        <td><%= expenditure.financing_source.name %></td>
        <td><%= expenditure.project_category&.name %></td>
        <td><%= expenditure.project_details %></td>
        <td><%= "#{expenditure.expenditure_article.code} - #{expenditure.expenditure_article.name}" %></td>
        <td><%= expenditure.details %></td>
        <td><%= expenditure.procurement_type %></td>
        <td><%= expenditure.ordinance_number %></td>
        <td><%= expenditure.ordinance_date&.strftime('%d.%m.%Y') %></td>
        <td><%= expenditure.value %></td>
        <td><%= expenditure.payment_method.name %></td>
        <td><%= expenditure.beneficiary %></td>
        <td><%= expenditure.invoice %></td>
        <td><%= expenditure.noncompliance %></td>
        <td><%= expenditure.remarks %></td>
        <td><%= expenditure.created_by_user.full_name %></td>
        <td><%= expenditure.created_at.strftime('%d.%m.%Y la %H:%M ora României') %></td>
        <td>
          <%= link_to 'Convertește în angajament',
                      new_commitment_path(source_expenditure_id: expenditure.id),
                      class: 'btn btn-primary' %>
        </td>
      </tr>
    <% end %>
    </tbody>
    <tfoot>
    <% if @expenditures.empty? %>
      <tr>
        <td colspan="17" class="ps-5 py-3">
          Nu a fost adăugată încă nicio cheltuială.
        </td>
      </tr>
    <% end %>
    </tfoot>
  </table>
</div>

<%= will_paginate @paginated_expenditures, renderer: WillPaginate::ActionView::BootstrapLinkRenderer %>

<section class="mt-5">
  <h2>Raport</h2>
  <p>Valorile de mai jos se referă strict la înregistrările care respectă criterile de filtrare selectate mai sus.</p>
  <p>
    Număr înregistrări: <%= @expenditures.count %>
  </p>
  <p>
    Valoare totală: <%= @expenditures.sum(:value) %> RON
  </p>
</section>
