<h1>Angajamente</h1>

<p><%= link_to 'Înapoi la pagina principală', root_path %></p>
<p><%= link_to 'Adaugă un angajament nou', new_commitment_path %></p>
<% if current_user.admin? %>
  <p><%= link_to 'Importă angajamente din Excel', import_commitments_path %></p>
<% end %>

<%= render partial: 'flashes' %>

<%= bootstrap_form_with method: :get, layout: :inline do |form| %>
  <%= form.text_field :start_date, value: params[:start_date], label: 'Data de început',
                      data: { datepicker: true, max_date: Time.zone.today.strftime('%d.%m.%Y') } %>
  <%= form.text_field :end_date, value: params[:end_date], label: 'Data de sfârșit',
                      data: { datepicker: true, max_date: Time.zone.today.strftime('%d.%m.%Y') } %>
  <%= form.text_field :commitment_category_code,
                      value: params[:commitment_category_code],
                      label: 'Indicator tip de angajament',
                      placeholder: 'Exemplu: A1' %>
  <%= form.select :expenditure_article_ids,
                  ExpenditureArticle.order(:code).map { |expenditure_article|
                    ["#{expenditure_article.code} - #{expenditure_article.name}", expenditure_article.id]
                  },
                  {
                    multiple: true,
                    selected: @expenditure_article_ids,
                    label: 'Articol de cheltuială',
                    wrapper: { class: 'col-12' }
                  },
                  {
                    data: {
                      use_select2: true,
                      placeholder: 'Selectează un articol de cheltuială...'
                    }
                  }
  %>
<% end %>

<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
    <tr>
      <th scope="col">Număr de înregistrare</th>
      <th scope="col">Data înregistrării</th>
      <th scope="col">Număr document</th>
      <th scope="col">Valabilitate</th>
      <th scope="col">Reprezentant UB / sursă de finanțare</th>
      <th scope="col">Articol de cheltuială</th>
      <th scope="col">Partener</th>
      <th scope="col">Valoare cu TVA (RON)</th>
      <th scope="col">Tip achiziție</th>
      <th scope="col">Neconformitate</th>
      <th scope="col">Observații</th>
      <th scope="col">Creat de</th>
      <th scope="col">Creat la data de</th>
    </tr>
    </thead>
    <tbody>
    <% @paginated_commitments.each do |commitment| %>
      <tr>
        <th scope="row"><%= commitment.registration_number %>/<%= commitment.year %></th>
        <td><%= commitment.registration_date.strftime('%d.%m.%Y') %></td>
        <td><%= commitment.document_number %></td>
        <td><%= commitment.validity %></td>
        <td><%= commitment.financing_source.name %></td>
        <td><%= "#{commitment.expenditure_article.code} - #{commitment.expenditure_article.name}" %></td>
        <td><%= commitment.partner %></td>
        <td><%= commitment.value %></td>
        <td><%= commitment.procurement_type %></td>
        <td><%= commitment.noncompliance %></td>
        <td><%= commitment.remarks %></td>
        <td><%= commitment.created_by_user.full_name %></td>
        <td><%= commitment.created_at.strftime('%d.%m.%Y la %H:%M ora României') %></td>
      </tr>
    <% end %>
    </tbody>
    <tfoot>
    <% if @commitments.empty? %>
      <tr>
        <td colspan="17" class="ps-5 py-3">
          Nu a fost adăugat încă niciun angajament.
        </td>
      </tr>
    <% end %>
    </tfoot>
  </table>
</div>

<%= will_paginate @paginated_commitments, renderer: WillPaginate::ActionView::BootstrapLinkRenderer %>

<section class="mt-5">
  <h2>Raport</h2>
  <p>Valorile de mai jos se referă strict la înregistrările care respectă criterile de filtrare selectate mai sus.</p>
  <p>
    Număr înregistrări: <%= @commitments.count %>
  </p>
  <p>
    Valoare totală: <%= @commitments.sum(:value) %> RON
  </p>
</section>
